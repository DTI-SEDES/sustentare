import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from datetime import datetime
import io

# Configuração da página
st.set_page_config(
    page_title="Programa de Sustentabilidade",
    page_icon="♻️",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Função para carregar os dados da planilha
@st.cache_data
def load_data():
    # Dados de destinação (peso em kg) por mês e ano
    dest_data = {
        'Ano': [2017, 2017, 2017, 2017, 2017, 2017, 2017, 2017, 2017, 2017, 2017, 2017,
                2018, 2018, 2018, 2018, 2018, 2018, 2018, 2018, 2018, 2018, 2018, 2018,
                2019, 2019, 2019, 2019, 2019, 2019, 2019, 2019, 2019, 2019, 2019, 2019,
                2020, 2020, 2020, 2020, 2020, 2020, 2020, 2020, 2020, 2020, 2020, 2020,
                2021, 2021, 2021, 2021, 2021, 2021, 2021, 2021, 2021, 2021, 2021, 2021,
                2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022,
                2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023,
                2024, 2024, 2024, 2024, 2024, 2024, 2024, 2024, 2024, 2024, 2024, 2024,
                2025, 2025, 2025, 2025, 2025, 2025, 2025, 2025, 2025],
        'Mês': ['JAN', 'FEV', 'MAR', 'ABR', 'MAI', 'JUN', 'JUL', 'AGO', 'SET', 'OUT', 'NOV', 'DEZ'] * 8 + ['JAN', 'FEV', 'MAR', 'ABR', 'MAI', 'JUN', 'JUL', 'AGO', 'SET'],
        'Peso_kg': [0, 0, 0, 656, 5195, 10285, 14281, 9392, 4837, 21930, 4588, 18267,
                    12826, 7247, 17465, 4284, 10069, 8692, 15695, 53658, 7000, 16446, 5164, 23688,
                    8215, 14810, 8322, 5038, 1177, 4409, 38880, 9425, 16944, 6692, 35531, 10698,
                    14097, 16825, 20622, 278, 9682, 7466, 53755, 9191, 32132, 15739, 38221, 22081,
                    20802, 1128, 2221, 5060, 20124, 15159, 6174, 23817, 21874, 24050, 9042, 7620,
                    11017, 14497, 25382, 10811, 9782, 22202, 19838, 33205, 19364, 15976, 6925, 15369,
                    24488, 5615, 32052, 10205, 24804, 34541, 46301, 18743, 26033, 44030, 30781, 12304,
                    17913, 11009, 12368, 15410, 12141, 13208, 28139, 36881, 23867, 30535, 13460, 14445,
                    18190, 8344, 1427, 21888, 27010, 36209, 29006, 8372, 9112]
    }
    
    # Dados de doações (quantidade) por mês e ano
    doacao_data = {
        'Ano': [2017, 2017, 2017, 2017, 2018, 2018, 2018, 2018, 2018, 2018, 2019, 2019, 2019, 2019, 2019, 2019, 2019,
                2020, 2020, 2020, 2020, 2020, 2020, 2020, 2020, 2020, 2020, 2020, 2021, 2021, 2021, 2021, 2021, 2021, 2021,
                2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022, 2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023,
                2024, 2024, 2024, 2024, 2024, 2024, 2024, 2024, 2024, 2024, 2024, 2024, 2025, 2025, 2025, 2025, 2025, 2025, 2025, 2025, 2025],
        'Mês': ['MAI', 'NOV', 'JAN', 'JUN', 'AGO', 'NOV', 'JAN', 'FEV', 'MAR', 'ABR', 'MAI', 'JUN', 'SET', 'DEZ', 'FEV', 'ABR', 'JUN', 'JUL', 'AGO', 'SET', 'MAR', 'JUN', 'JUL', 'AGO', 'SET', 'OUT', 'NOV', 'DEZ', 'FEV', 'JUN', 'JUL', 'AGO', 'SET', 'MAR', 'MAI', 'JUN', 'JUL', 'AGO', 'SET', 'OUT', 'NOV', 'DEZ', 'FEV', 'MAR', 'ABR', 'MAI', 'JUN', 'JUL', 'AGO', 'SET', 'OUT', 'NOV', 'DEZ', 'JAN', 'FEV', 'MAR', 'ABR', 'JUN', 'JUL', 'AGO', 'SET', 'OUT', 'NOV', 'FEV', 'MAR', 'ABR', 'MAI', 'JUN', 'JUL', 'AGO', 'SET'],
        'Quantidade': [45, 24, 11, 26, 17, 18, 10, 40, 5, 70, 20, 33, 35, 11, 2, 20, 33, 3, 5, 3, 15, 5, 15, 5, 3, 11, 4, 44, 48, 20, 10, 10, 41, 8, 21, 70, 30, 29, 10, 74, 58, 106, 39, 51, 93, 84, 70, 60, 107, 15, 74, 25, 55, 120, 42, 49, 47, 70, 99, 154, 408, 136, 51, 91, 174, 115, 123, 95, 124]
    }
    
    # Criar DataFrames
    df_dest = pd.DataFrame(dest_data)
    df_doacao = pd.DataFrame(doacao_data)
    
    # Adicionar coluna de data completa para ordenação
    meses_pt = {'JAN': 1, 'FEV': 2, 'MAR': 3, 'ABR': 4, 'MAI': 5, 'JUN': 6, 
                'JUL': 7, 'AGO': 8, 'SET': 9, 'OUT': 10, 'NOV': 11, 'DEZ': 12}
    
    df_dest['Mes_num'] = df_dest['Mês'].map(meses_pt)
    df_dest['Data'] = pd.to_datetime(df_dest['Ano'].astype(str) + '-' + df_dest['Mes_num'].astype(str) + '-01')
    
    df_doacao['Mes_num'] = df_doacao['Mês'].map(meses_pt)
    df_doacao['Data'] = pd.to_datetime(df_doacao['Ano'].astype(str) + '-' + df_doacao['Mes_num'].astype(str) + '-01')
    
    return df_dest, df_doacao

# Carregar dados
df_dest, df_doacao = load_data()

# Sidebar
st.sidebar.title("Navegação")
aba_selecionada = st.sidebar.radio("Selecione a aba:", ["Início", "Sobre", "DADOS de Destinação", "Doados"])

# Página Início
if aba_selecionada == "Início":
    st.title("Programa de Sustentabilidade - Análise de Dados")
    st.markdown("---")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader("Resumo de Destinação")
        total_dest = df_dest['Peso_kg'].sum()
        st.metric("Total de Materiais Destinados", f"{total_dest:,.0f} kg")
        
        # Gráfico de destinação por ano
        dest_ano = df_dest.groupby('Ano')['Peso_kg'].sum().reset_index()
        fig_dest = px.bar(dest_ano, x='Ano', y='Peso_kg', 
                         title="Destinação de Materiais por Ano (kg)",
                         labels={'Peso_kg': 'Peso (kg)', 'Ano': 'Ano'})
        st.plotly_chart(fig_dest, use_container_width=True)
    
    with col2:
        st.subheader("Resumo de Doações")
        total_doacao = df_doacao['Quantidade'].sum()
        st.metric("Total de Itens Doados", f"{total_doacao:,.0f} unidades")
        
        # Gráfico de doações por ano
        doacao_ano = df_doacao.groupby('Ano')['Quantidade'].sum().reset_index()
        fig_doacao = px.bar(doacao_ano, x='Ano', y='Quantidade', 
                           title="Doações por Ano (unidades)",
                           labels={'Quantidade': 'Quantidade', 'Ano': 'Ano'})
        st.plotly_chart(fig_doacao, use_container_width=True)
    
    st.markdown("---")
    st.subheader("Visão Geral do Programa")
    st.markdown("""
    Este programa governamental tem como objetivo promover a sustentabilidade através de:
    - **Destinação adequada** de materiais eletrônicos e outros resíduos
    - **Doação de equipamentos** recondicionados para instituições
    - **Redução do impacto ambiental** através da reciclagem e reutilização
    
    Os dados apresentados mostram a evolução das atividades do programa ao longo dos anos,
    demonstrando seu crescimento e impacto positivo na sociedade.
    """)

# Página Sobre
elif aba_selecionada == "Sobre":
    st.title("Sobre o Programa")
    st.markdown("---")
    
    st.subheader("Objetivos do Programa")
    st.markdown("""
    O Programa de Sustentabilidade tem como principais objetivos:
    
    1. **Promover a destinação ambientalmente adequada** de resíduos eletrônicos e outros materiais
    2. **Fomentar a economia circular** através do reaproveitamento de equipamentos
    3. **Reduzir o impacto ambiental** causado pelo descarte inadequado
    4. **Beneficiar instituições** através da doação de equipamentos recondicionados
    5. **Conscientizar a sociedade** sobre a importância da sustentabilidade
    """)
    
    st.subheader("Metodologia")
    st.markdown("""
    O programa opera através de:
    
    - **Coleta seletiva** de materiais em pontos específicos
    - **Triagem e classificação** dos itens recebidos
    - **Reparação e recondicionamento** de equipamentos eletrônicos
    - **Destinação adequada** de materiais não passíveis de reaproveitamento
    - **Distribuição** dos equipamentos recondicionados para instituições beneficiárias
    """)
    
    st.subheader("Impacto")
    st.markdown("""
    Desde sua implementação, o programa já:
    
    - Destinou **{:,} kg** de materiais adequadamente
    - Doou **{:,}** equipamentos recondicionados
    - Beneficiou diversas instituições em todo o estado
    - Contribuiu para a redução de resíduos em aterros sanitários
    """.format(df_dest['Peso_kg'].sum(), df_doacao['Quantidade'].sum()))

# Página DADOS de Destinação
elif aba_selecionada == "DADOS de Destinação":
    st.title("DADOS de Destinação")
    st.markdown("---")
    
    # Filtros
    col1, col2 = st.columns(2)
    
    with col1:
        anos = sorted(df_dest['Ano'].unique())
        ano_selecionado = st.selectbox("Selecione o ano:", ["Todos"] + anos)
    
    with col2:
        meses = sorted(df_dest['Mês'].unique(), key=lambda x: list({'JAN': 1, 'FEV': 2, 'MAR': 3, 'ABR': 4, 'MAI': 5, 'JUN': 6, 
                                                                    'JUL': 7, 'AGO': 8, 'SET': 9, 'OUT': 10, 'NOV': 11, 'DEZ': 12}.keys()).index(x))
        mes_selecionado = st.selectbox("Selecione o mês:", ["Todos"] + meses)
    
    # Aplicar filtros
    df_filtrado = df_dest.copy()
    
    if ano_selecionado != "Todos":
        df_filtrado = df_filtrado[df_filtrado['Ano'] == ano_selecionado]
    
    if mes_selecionado != "Todos":
        df_filtrado = df_filtrado[df_filtrado['Mês'] == mes_selecionado]
    
    # Métricas
    col1, col2, col3 = st.columns(3)
    
    with col1:
        total_filtrado = df_filtrado['Peso_kg'].sum()
        st.metric("Total Destinado (kg)", f"{total_filtrado:,.0f}")
    
    with col2:
        media_mensal = df_filtrado.groupby(['Ano', 'Mês'])['Peso_kg'].sum().mean()
        st.metric("Média Mensal (kg)", f"{media_mensal:,.0f}")
    
    with col3:
        max_mes = df_filtrado.loc[df_filtrado['Peso_kg'].idxmax()] if not df_filtrado.empty else None
        if max_mes is not None:
            st.metric("Mês com Maior Destinação", f"{max_mes['Mês']}/{max_mes['Ano']}")
    
    st.markdown("---")
    
    # Gráficos
    col1, col2 = st.columns(2)
    
    with col1:
        if ano_selecionado == "Todos":
            # Gráfico de destinação por ano
            dest_ano = df_filtrado.groupby('Ano')['Peso_kg'].sum().reset_index()
            fig_ano = px.bar(dest_ano, x='Ano', y='Peso_kg',
                            title="Destinação por Ano (kg)",
                            labels={'Peso_kg': 'Peso (kg)', 'Ano': 'Ano'})
            st.plotly_chart(fig_ano, use_container_width=True)
        else:
            # Gráfico de destinação por mês no ano selecionado
            dest_mes = df_filtrado.groupby('Mês')['Peso_kg'].sum().reset_index()
            # Ordenar por ordem dos meses
            ordem_meses = ['JAN', 'FEV', 'MAR', 'ABR', 'MAI', 'JUN', 'JUL', 'AGO', 'SET', 'OUT', 'NOV', 'DEZ']
            dest_mes['Mês'] = pd.Categorical(dest_mes['Mês'], categories=ordem_meses, ordered=True)
            dest_mes = dest_mes.sort_values('Mês')
            
            fig_mes = px.bar(dest_mes, x='Mês', y='Peso_kg',
                            title=f"Destinação por Mês em {ano_selecionado} (kg)",
                            labels={'Peso_kg': 'Peso (kg)', 'Mês': 'Mês'})
            st.plotly_chart(fig_mes, use_container_width=True)
    
    with col2:
        # Gráfico de linha temporal
        df_temporal = df_filtrado.sort_values('Data')
        fig_temporal = px.line(df_temporal, x='Data', y='Peso_kg',
                              title="Evolução Temporal da Destinação (kg)",
                              labels={'Peso_kg': 'Peso (kg)', 'Data': 'Data'})
        st.plotly_chart(fig_temporal, use_container_width=True)
    
    # Tabela de dados
    st.subheader("Dados Detalhados")
    df_tabela = df_filtrado[['Ano', 'Mês', 'Peso_kg']].sort_values(['Ano', 'Mes_num'])
    df_tabela = df_tabela.rename(columns={'Peso_kg': 'Peso (kg)'})
    st.dataframe(df_tabela, use_container_width=True)
    
    # Botão para download
    csv = df_tabela.to_csv(index=False)
    st.download_button(
        label="Baixar dados como CSV",
        data=csv,
        file_name=f"dados_destinacao_{datetime.now().strftime('%Y%m%d')}.csv",
        mime="text/csv"
    )

# Página Doados
elif aba_selecionada == "Doados":
    st.title("Itens Doados")
    st.markdown("---")
    
    # Filtros
    col1, col2 = st.columns(2)
    
    with col1:
        anos_doacao = sorted(df_doacao['Ano'].unique())
        ano_selecionado_doacao = st.selectbox("Selecione o ano:", ["Todos"] + anos_doacao, key="ano_doacao")
    
    with col2:
        meses_doacao = sorted(df_doacao['Mês'].unique(), key=lambda x: list({'JAN': 1, 'FEV': 2, 'MAR': 3, 'ABR': 4, 'MAI': 5, 'JUN': 6, 
                                                                             'JUL': 7, 'AGO': 8, 'SET': 9, 'OUT': 10, 'NOV': 11, 'DEZ': 12}.keys()).index(x))
        mes_selecionado_doacao = st.selectbox("Selecione o mês:", ["Todos"] + meses_doacao, key="mes_doacao")
    
    # Aplicar filtros
    df_filtrado_doacao = df_doacao.copy()
    
    if ano_selecionado_doacao != "Todos":
        df_filtrado_doacao = df_filtrado_doacao[df_filtrado_doacao['Ano'] == ano_selecionado_doacao]
    
    if mes_selecionado_doacao != "Todos":
        df_filtrado_doacao = df_filtrado_doacao[df_filtrado_doacao['Mês'] == mes_selecionado_doacao]
    
    # Métricas
    col1, col2, col3 = st.columns(3)
    
    with col1:
        total_filtrado_doacao = df_filtrado_doacao['Quantidade'].sum()
        st.metric("Total Doado", f"{total_filtrado_doacao:,.0f} unidades")
    
    with col2:
        media_mensal_doacao = df_filtrado_doacao.groupby(['Ano', 'Mês'])['Quantidade'].sum().mean()
        st.metric("Média Mensal", f"{media_mensal_doacao:,.0f} unidades")
    
    with col3:
        max_mes_doacao = df_filtrado_doacao.loc[df_filtrado_doacao['Quantidade'].idxmax()] if not df_filtrado_doacao.empty else None
        if max_mes_doacao is not None:
            st.metric("Mês com Mais Doações", f"{max_mes_doacao['Mês']}/{max_mes_doacao['Ano']}")
    
    st.markdown("---")
    
    # Gráficos
    col1, col2 = st.columns(2)
    
    with col1:
        if ano_selecionado_doacao == "Todos":
            # Gráfico de doações por ano
            doacao_ano = df_filtrado_doacao.groupby('Ano')['Quantidade'].sum().reset_index()
            fig_ano_doacao = px.bar(doacao_ano, x='Ano', y='Quantidade',
                                   title="Doações por Ano (unidades)",
                                   labels={'Quantidade': 'Quantidade', 'Ano': 'Ano'})
            st.plotly_chart(fig_ano_doacao, use_container_width=True)
        else:
            # Gráfico de doações por mês no ano selecionado
            doacao_mes = df_filtrado_doacao.groupby('Mês')['Quantidade'].sum().reset_index()
            # Ordenar por ordem dos meses
            ordem_meses = ['JAN', 'FEV', 'MAR', 'ABR', 'MAI', 'JUN', 'JUL', 'AGO', 'SET', 'OUT', 'NOV', 'DEZ']
            doacao_mes['Mês'] = pd.Categorical(doacao_mes['Mês'], categories=ordem_meses, ordered=True)
            doacao_mes = doacao_mes.sort_values('Mês')
            
            fig_mes_doacao = px.bar(doacao_mes, x='Mês', y='Quantidade',
                                   title=f"Doações por Mês em {ano_selecionado_doacao} (unidades)",
                                   labels={'Quantidade': 'Quantidade', 'Mês': 'Mês'})
            st.plotly_chart(fig_mes_doacao, use_container_width=True)
    
    with col2:
        # Gráfico de linha temporal
        df_temporal_doacao = df_filtrado_doacao.sort_values('Data')
        fig_temporal_doacao = px.line(df_temporal_doacao, x='Data', y='Quantidade',
                                     title="Evolução Temporal das Doações (unidades)",
                                     labels={'Quantidade': 'Quantidade', 'Data': 'Data'})
        st.plotly_chart(fig_temporal_doacao, use_container_width=True)
    
    # Tabela de dados
    st.subheader("Dados Detalhados")
    df_tabela_doacao = df_filtrado_doacao[['Ano', 'Mês', 'Quantidade']].sort_values(['Ano', 'Mes_num'])
    df_tabela_doacao = df_tabela_doacao.rename(columns={'Quantidade': 'Quantidade (unidades)'})
    st.dataframe(df_tabela_doacao, use_container_width=True)
    
    # Botão para download
    csv_doacao = df_tabela_doacao.to_csv(index=False)
    st.download_button(
        label="Baixar dados como CSV",
        data=csv_doacao,
        file_name=f"dados_doacoes_{datetime.now().strftime('%Y%m%d')}.csv",
        mime="text/csv",
        key="download_doacao"
    )

# Rodapé
st.markdown("---")
st.markdown(
    "<div style='text-align: center; color: gray;'>Programa de Sustentabilidade - Dados de 2017 a 2025</div>",
    unsafe_allow_html=True
)
